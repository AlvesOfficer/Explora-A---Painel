local plrs=game:GetService("Players")
local rs=game:GetService("RunService")
local uis=game:GetService("UserInputService")
local lp=plrs.LocalPlayer
local cam=workspace.CurrentCamera

local config={
    espOn=true,
    aimOn=true,
    aimActive=false,
    aimMode="F",
    fovVal=150,
    targetPart="UpperTorso",
    texCullOn=false,
    qualityLevel=10,
    smoothness=0.15,
    prediction=0.13,
    wallCheck=false,
    aimAtTeammates=false,
    autoDetectTeams=true
}

local gameHasTeams=false
local teamCheckComplete=false

local savedConfigs={}
local cache={}
local cullCache={}
local dragStates={fov=false,cull=false,smooth=false,pred=false}
local lastCullUpdate=0
local renderConnection=nil
local qualityUpdateNeeded=false

-- CRIAR SCREENGUI
local sg=Instance.new("ScreenGui")
sg.Name="ExploitsAPanel"
sg.ResetOnSpawn=false
sg.ZIndexBehavior=Enum.ZIndexBehavior.Sibling
sg.Parent=game.CoreGui

-- FOV CIRCLE
local fovCirc=Drawing.new("Circle")
fovCirc.Thickness=2
fovCirc.NumSides=32
fovCirc.Radius=config.fovVal
fovCirc.Filled=false
fovCirc.Transparency=1
fovCirc.Color=Color3.fromRGB(255,255,255)
fovCirc.Visible=true

-- PAINEL PRINCIPAL (ESTILO FIVEM)
local mf=Instance.new("Frame")
mf.Name="MainFrame"
mf.Size=UDim2.new(0,300,0,500)
mf.Position=UDim2.new(0.5,-150,0.5,-250)
mf.BackgroundColor3=Color3.fromRGB(20,20,20)
mf.BorderSizePixel=2
mf.BorderColor3=Color3.fromRGB(60,60,60)
mf.Active=true
mf.Draggable=true
mf.Parent=sg

-- HEADER
local header=Instance.new("Frame")
header.Size=UDim2.new(1,0,0,35)
header.BackgroundColor3=Color3.fromRGB(30,30,30)
header.BorderSizePixel=0
header.Parent=mf

local title=Instance.new("TextLabel")
title.Size=UDim2.new(1,-80,1,0)
title.Position=UDim2.new(0,10,0,0)
title.BackgroundTransparency=1
title.Text="EXPLOITS A - PAINEL BETA"
title.TextColor3=Color3.fromRGB(240,240,240)
title.TextSize=15
title.Font=Enum.Font.GothamBold
title.TextXAlignment=Enum.TextXAlignment.Left
title.TextStrokeTransparency=0.5
title.Parent=header

local minBtn=Instance.new("TextButton")
minBtn.Size=UDim2.new(0,35,0,30)
minBtn.Position=UDim2.new(1,-75,0,2.5)
minBtn.BackgroundColor3=Color3.fromRGB(40,40,40)
minBtn.BorderSizePixel=1
minBtn.BorderColor3=Color3.fromRGB(70,70,70)
minBtn.Text="_"
minBtn.TextColor3=Color3.fromRGB(200,200,200)
minBtn.TextSize=16
minBtn.Font=Enum.Font.Code
minBtn.Parent=header

local closeBtn=Instance.new("TextButton")
closeBtn.Size=UDim2.new(0,35,0,30)
closeBtn.Position=UDim2.new(1,-37.5,0,2.5)
closeBtn.BackgroundColor3=Color3.fromRGB(150,40,40)
closeBtn.BorderSizePixel=1
closeBtn.BorderColor3=Color3.fromRGB(180,60,60)
closeBtn.Text="X"
closeBtn.TextColor3=Color3.fromRGB(255,255,255)
closeBtn.TextSize=14
closeBtn.Font=Enum.Font.Code
closeBtn.Parent=header

-- DIVIDER
local div1=Instance.new("Frame")
div1.Size=UDim2.new(1,0,0,1)
div1.Position=UDim2.new(0,0,0,35)
div1.BackgroundColor3=Color3.fromRGB(60,60,60)
div1.BorderSizePixel=0
div1.Parent=mf

-- CONTENT
local content=Instance.new("ScrollingFrame")
content.Size=UDim2.new(1,-10,1,-75)
content.Position=UDim2.new(0,5,0,40)
content.BackgroundTransparency=1
content.BorderSizePixel=0
content.ScrollBarThickness=4
content.ScrollBarImageColor3=Color3.fromRGB(100,100,100)
content.CanvasSize=UDim2.new(0,0,0,860)
content.Parent=mf

-- FUNÇÃO CRIAR TOGGLE
local function createToggle(name,yPos,enabled)
    local frame=Instance.new("Frame")
    frame.Size=UDim2.new(1,0,0,32)
    frame.Position=UDim2.new(0,0,0,yPos)
    frame.BackgroundColor3=Color3.fromRGB(28,28,28)
    frame.BorderSizePixel=1
    frame.BorderColor3=Color3.fromRGB(50,50,50)
    frame.Parent=content
    
    local lbl=Instance.new("TextLabel")
    lbl.Size=UDim2.new(0,200,1,0)
    lbl.Position=UDim2.new(0,10,0,0)
    lbl.BackgroundTransparency=1
    lbl.Text=name
    lbl.TextColor3=Color3.fromRGB(230,230,230)
    lbl.TextSize=13
    lbl.Font=Enum.Font.GothamBold
    lbl.TextXAlignment=Enum.TextXAlignment.Left
    lbl.TextStrokeTransparency=0.7
    lbl.Parent=frame
    
    local btn=Instance.new("TextButton")
    btn.Size=UDim2.new(0,50,0,22)
    btn.Position=UDim2.new(1,-57,0,5)
    btn.BackgroundColor3=enabled and Color3.fromRGB(60,150,60) or Color3.fromRGB(150,60,60)
    btn.BorderSizePixel=1
    btn.BorderColor3=Color3.fromRGB(80,80,80)
    btn.Text=enabled and "ON" or "OFF"
    btn.TextColor3=Color3.fromRGB(255,255,255)
    btn.TextSize=11
    btn.Font=Enum.Font.GothamBold
    btn.TextStrokeTransparency=0.5
    btn.Parent=frame
    
    return {frame=frame,btn=btn,lbl=lbl}
end

-- FUNÇÃO CRIAR SLIDER
local function createSlider(name,yPos,value,min,max,suffix)
    local frame=Instance.new("Frame")
    frame.Size=UDim2.new(1,0,0,48)
    frame.Position=UDim2.new(0,0,0,yPos)
    frame.BackgroundColor3=Color3.fromRGB(28,28,28)
    frame.BorderSizePixel=1
    frame.BorderColor3=Color3.fromRGB(50,50,50)
    frame.Parent=content
    
    local lbl=Instance.new("TextLabel")
    lbl.Size=UDim2.new(0.6,0,0,20)
    lbl.Position=UDim2.new(0,10,0,4)
    lbl.BackgroundTransparency=1
    lbl.Text=name
    lbl.TextColor3=Color3.fromRGB(230,230,230)
    lbl.TextSize=13
    lbl.Font=Enum.Font.GothamBold
    lbl.TextXAlignment=Enum.TextXAlignment.Left
    lbl.TextStrokeTransparency=0.7
    lbl.Parent=frame
    
    local val=Instance.new("TextLabel")
    val.Size=UDim2.new(0,80,0,20)
    val.Position=UDim2.new(1,-90,0,4)
    val.BackgroundTransparency=1
    val.Text=value..(suffix or "")
    val.TextColor3=Color3.fromRGB(180,180,180)
    val.TextSize=12
    val.Font=Enum.Font.GothamBold
    val.TextXAlignment=Enum.TextXAlignment.Right
    val.TextStrokeTransparency=0.7
    val.Parent=frame
    
    local track=Instance.new("Frame")
    track.Size=UDim2.new(1,-20,0,8)
    track.Position=UDim2.new(0,10,0,30)
    track.BackgroundColor3=Color3.fromRGB(35,35,35)
    track.BorderSizePixel=1
    track.BorderColor3=Color3.fromRGB(60,60,60)
    track.Parent=frame
    
    local fill=Instance.new("Frame")
    fill.Size=UDim2.new((value-min)/(max-min),0,1,0)
    fill.BackgroundColor3=Color3.fromRGB(100,100,100)
    fill.BorderSizePixel=0
    fill.Parent=track
    
    local btn=Instance.new("TextButton")
    btn.Size=UDim2.new(1,0,1,0)
    btn.BackgroundTransparency=1
    btn.Text=""
    btn.Parent=track
    
    return {frame=frame,value=val,fill=fill,button=btn,min=min,max=max,suffix=suffix}
end

-- FUNÇÃO CRIAR SEÇÃO
local function createSection(title,yPos)
    local frame=Instance.new("Frame")
    frame.Size=UDim2.new(1,0,0,28)
    frame.Position=UDim2.new(0,0,0,yPos)
    frame.BackgroundColor3=Color3.fromRGB(35,35,35)
    frame.BorderSizePixel=1
    frame.BorderColor3=Color3.fromRGB(60,60,60)
    frame.Parent=content
    
    local lbl=Instance.new("TextLabel")
    lbl.Size=UDim2.new(1,0,1,0)
    lbl.BackgroundTransparency=1
    lbl.Text=title
    lbl.TextColor3=Color3.fromRGB(200,200,200)
    lbl.TextSize=12
    lbl.Font=Enum.Font.GothamBold
    lbl.TextStrokeTransparency=0.7
    lbl.Parent=frame
    
    return frame
end

-- CRIAR UI
local espToggle=createToggle("ESP",0,config.espOn)
local aimToggle=createToggle("AIMBOT",35,config.aimOn)
local cullToggle=createToggle("OPTIMIZER",70,config.texCullOn)
local wallToggle=createToggle("IGNORAR PAREDE",105,config.wallCheck)
local teammateToggle=createToggle("MIRAR EM AMIGOS",140,config.aimAtTeammates)

createSection("MODO AIMBOT",180)

local modeFrame=Instance.new("Frame")
modeFrame.Size=UDim2.new(1,0,0,30)
modeFrame.Position=UDim2.new(0,0,0,210)
modeFrame.BackgroundColor3=Color3.fromRGB(25,25,25)
modeFrame.BorderSizePixel=1
modeFrame.BorderColor3=Color3.fromRGB(50,50,50)
modeFrame.Parent=content

local modeF=Instance.new("TextButton")
modeF.Size=UDim2.new(0.48,0,0,22)
modeF.Position=UDim2.new(0,4,0,4)
modeF.BackgroundColor3=Color3.fromRGB(100,100,100)
modeF.BorderSizePixel=1
modeF.BorderColor3=Color3.fromRGB(120,120,120)
modeF.Text="TECLA F"
modeF.TextColor3=Color3.fromRGB(255,255,255)
modeF.TextSize=11
modeF.Font=Enum.Font.Code
modeF.Parent=modeFrame

local modeC=Instance.new("TextButton")
modeC.Size=UDim2.new(0.48,0,0,22)
modeC.Position=UDim2.new(0.52,0,0,4)
modeC.BackgroundColor3=Color3.fromRGB(50,50,50)
modeC.BorderSizePixel=1
modeC.BorderColor3=Color3.fromRGB(70,70,70)
modeC.Text="CTRL"
modeC.TextColor3=Color3.fromRGB(150,150,150)
modeC.TextSize=11
modeC.Font=Enum.Font.Code
modeC.Parent=modeFrame

createSection("CONFIGURACOES",250)

local smoothSlider=createSlider("Suavidade",280,math.floor(config.smoothness*100),0,100,"%")
local predSlider=createSlider("Predicao",330,math.floor(config.prediction*100),0,100,"%")
local fovSlider=createSlider("FOV",380,config.fovVal,5,500,"")
local qualitySlider=createSlider("Qualidade Grafica",430,config.qualityLevel,1,21,"")

createSection("ALVO",480)

-- TARGET SELECTOR COM BONECO
local targetFrame=Instance.new("Frame")
targetFrame.Size=UDim2.new(1,0,0,180)
targetFrame.Position=UDim2.new(0,0,0,510)
targetFrame.BackgroundColor3=Color3.fromRGB(25,25,25)
targetFrame.BorderSizePixel=1
targetFrame.BorderColor3=Color3.fromRGB(50,50,50)
targetFrame.Parent=content

-- BONECO VISUAL
local dummyFrame=Instance.new("Frame")
dummyFrame.Size=UDim2.new(0,70,0,140)
dummyFrame.Position=UDim2.new(0,5,0,25)
dummyFrame.BackgroundTransparency=1
dummyFrame.Parent=targetFrame

local bodyParts={
    {name="Head",size=UDim2.new(0,20,0,20),pos=UDim2.new(0,25,0,0),color=Color3.fromRGB(255,204,153)},
    {name="UpperTorso",size=UDim2.new(0,24,0,28),pos=UDim2.new(0,23,0,20),color=Color3.fromRGB(13,105,172)},
    {name="LeftUpperArm",size=UDim2.new(0,10,0,28),pos=UDim2.new(0,11,0,20),color=Color3.fromRGB(255,204,153)},
    {name="RightUpperArm",size=UDim2.new(0,10,0,28),pos=UDim2.new(0,49,0,20),color=Color3.fromRGB(255,204,153)},
    {name="LeftUpperLeg",size=UDim2.new(0,11,0,40),pos=UDim2.new(0,24,0,48),color=Color3.fromRGB(13,105,172)},
    {name="RightUpperLeg",size=UDim2.new(0,11,0,40),pos=UDim2.new(0,35,0,48),color=Color3.fromRGB(13,105,172)}
}

local bodyVisuals={}
for _,part in ipairs(bodyParts) do
    local p=Instance.new("Frame")
    p.Size=part.size
    p.Position=part.pos
    p.BackgroundColor3=part.color
    p.BorderSizePixel=1
    p.BorderColor3=Color3.fromRGB(60,60,60)
    p.Parent=dummyFrame
    bodyVisuals[part.name]=p
end

-- BOTÕES DE SELEÇÃO
local btnFrame=Instance.new("Frame")
btnFrame.Size=UDim2.new(0,205,0,140)
btnFrame.Position=UDim2.new(0,80,0,25)
btnFrame.BackgroundTransparency=1
btnFrame.Parent=targetFrame

local parts={
    {name="Head",y=0},
    {name="UpperTorso",y=23},
    {name="LeftUpperArm",y=46},
    {name="RightUpperArm",y=69},
    {name="LeftUpperLeg",y=92},
    {name="RightUpperLeg",y=115}
}

local targetBtns={}
for _,p in ipairs(parts) do
    local btn=Instance.new("TextButton")
    btn.Size=UDim2.new(1,0,0,20)
    btn.Position=UDim2.new(0,0,0,p.y)
    btn.BackgroundColor3=Color3.fromRGB(35,35,35)
    btn.BorderSizePixel=1
    btn.BorderColor3=Color3.fromRGB(60,60,60)
    btn.Text=p.name
    btn.TextColor3=Color3.fromRGB(180,180,180)
    btn.TextSize=11
    btn.Font=Enum.Font.Code
    btn.Parent=btnFrame
    
    targetBtns[p.name]=btn
end

-- SEÇÃO SALVOS
createSection("SALVOS",700)

local saveFrame=Instance.new("Frame")
saveFrame.Size=UDim2.new(1,0,0,120)
saveFrame.Position=UDim2.new(0,0,0,730)
saveFrame.BackgroundColor3=Color3.fromRGB(25,25,25)
saveFrame.BorderSizePixel=1
saveFrame.BorderColor3=Color3.fromRGB(50,50,50)
saveFrame.Parent=content

local saveInput=Instance.new("TextBox")
saveInput.Size=UDim2.new(1,-10,0,25)
saveInput.Position=UDim2.new(0,5,0,5)
saveInput.BackgroundColor3=Color3.fromRGB(35,35,35)
saveInput.BorderSizePixel=1
saveInput.BorderColor3=Color3.fromRGB(60,60,60)
saveInput.Text="Nome da Config"
saveInput.TextColor3=Color3.fromRGB(200,200,200)
saveInput.TextSize=11
saveInput.Font=Enum.Font.Code
saveInput.PlaceholderText="Digite o nome..."
saveInput.PlaceholderColor3=Color3.fromRGB(100,100,100)
saveInput.ClearTextOnFocus=false
saveInput.Parent=saveFrame

local saveBtn=Instance.new("TextButton")
saveBtn.Size=UDim2.new(0.48,0,0,25)
saveBtn.Position=UDim2.new(0,5,0,35)
saveBtn.BackgroundColor3=Color3.fromRGB(60,150,60)
saveBtn.BorderSizePixel=1
saveBtn.BorderColor3=Color3.fromRGB(80,180,80)
saveBtn.Text="SALVAR"
saveBtn.TextColor3=Color3.fromRGB(255,255,255)
saveBtn.TextSize=11
saveBtn.Font=Enum.Font.Code
saveBtn.Parent=saveFrame

local loadBtn=Instance.new("TextButton")
loadBtn.Size=UDim2.new(0.48,0,0,25)
loadBtn.Position=UDim2.new(0.52,0,0,35)
loadBtn.BackgroundColor3=Color3.fromRGB(60,60,150)
loadBtn.BorderSizePixel=1
loadBtn.BorderColor3=Color3.fromRGB(80,80,180)
loadBtn.Text="CARREGAR"
loadBtn.TextColor3=Color3.fromRGB(255,255,255)
loadBtn.TextSize=11
loadBtn.Font=Enum.Font.Code
loadBtn.Parent=saveFrame

local savedList=Instance.new("ScrollingFrame")
savedList.Size=UDim2.new(1,-10,0,50)
savedList.Position=UDim2.new(0,5,0,65)
savedList.BackgroundColor3=Color3.fromRGB(30,30,30)
savedList.BorderSizePixel=1
savedList.BorderColor3=Color3.fromRGB(50,50,50)
savedList.ScrollBarThickness=3
savedList.ScrollBarImageColor3=Color3.fromRGB(100,100,100)
savedList.CanvasSize=UDim2.new(0,0,0,0)
savedList.Parent=saveFrame

local listLayout=Instance.new("UIListLayout")
listLayout.SortOrder=Enum.SortOrder.LayoutOrder
listLayout.Padding=UDim.new(0,2)
listLayout.Parent=savedList

-- FOOTER
local footer=Instance.new("Frame")
footer.Size=UDim2.new(1,0,0,30)
footer.Position=UDim2.new(0,0,1,-30)
footer.BackgroundColor3=Color3.fromRGB(25,25,25)
footer.BorderSizePixel=0
footer.Parent=mf

local div2=Instance.new("Frame")
div2.Size=UDim2.new(1,0,0,1)
div2.BackgroundColor3=Color3.fromRGB(60,60,60)
div2.BorderSizePixel=0
div2.Parent=footer

local footerText=Instance.new("TextLabel")
footerText.Size=UDim2.new(1,0,1,0)
footerText.BackgroundTransparency=1
footerText.Text="[INSERT] Menu"
footerText.TextColor3=Color3.fromRGB(120,120,120)
footerText.TextSize=10
footerText.Font=Enum.Font.Code
footerText.Parent=footer

-- DECLARAÇÃO FORWARD DAS FUNÇÕES
local updateTargetVisual
local updateAimMode
local toggleButton
local updateSavedList

-- FUNÇÕES DE SALVAR/CARREGAR
local function saveConfig(name)
    if name=="" or name=="Nome da Config" then return end
    
    savedConfigs[name]={
        espOn=config.espOn,
        aimOn=config.aimOn,
        aimMode=config.aimMode,
        fovVal=config.fovVal,
        targetPart=config.targetPart,
        texCullOn=config.texCullOn,
        qualityLevel=config.qualityLevel,
        smoothness=config.smoothness,
        prediction=config.prediction,
        wallCheck=config.wallCheck,
        aimAtTeammates=config.aimAtTeammates
    }
    
    updateSavedList()
    print("Config '"..name.."' salva!")
end

local function loadConfig(name)
    local cfg=savedConfigs[name]
    if not cfg then return end
    
    config.espOn=cfg.espOn
    config.aimOn=cfg.aimOn
    config.aimMode=cfg.aimMode
    config.fovVal=cfg.fovVal
    config.targetPart=cfg.targetPart
    config.texCullOn=cfg.texCullOn
    config.qualityLevel=cfg.qualityLevel
    config.smoothness=cfg.smoothness
    config.prediction=cfg.prediction
    config.wallCheck=cfg.wallCheck
    config.aimAtTeammates=cfg.aimAtTeammates or false
    
    -- Atualiza UI
    toggleButton(espToggle,config.espOn)
    toggleButton(aimToggle,config.aimOn)
    toggleButton(cullToggle,config.texCullOn)
    toggleButton(wallToggle,config.wallCheck)
    toggleButton(teammateToggle,config.aimAtTeammates)
    updateAimMode()
    updateTargetVisual()
    
    smoothSlider.value.Text=math.floor(config.smoothness*100).."%"
    smoothSlider.fill.Size=UDim2.new(config.smoothness,0,1,0)
    
    predSlider.value.Text=math.floor(config.prediction*100).."%"
    predSlider.fill.Size=UDim2.new(config.prediction,0,1,0)
    
    fovSlider.value.Text=config.fovVal
    fovSlider.fill.Size=UDim2.new((config.fovVal-5)/495,0,1,0)
    fovCirc.Radius=config.fovVal
    
    qualitySlider.value.Text=config.qualityLevel
    qualitySlider.fill.Size=UDim2.new((config.qualityLevel-1)/20,0,1,0)
    qualityUpdateNeeded=true
    
    print("Config '"..name.."' carregada!")
end

updateSavedList=function()
    for _,child in pairs(savedList:GetChildren()) do
        if child:IsA("TextButton") then child:Destroy() end
    end
    
    local y=0
    for name,_ in pairs(savedConfigs) do
        local btn=Instance.new("TextButton")
        btn.Size=UDim2.new(1,-5,0,20)
        btn.BackgroundColor3=Color3.fromRGB(40,40,40)
        btn.BorderSizePixel=1
        btn.BorderColor3=Color3.fromRGB(60,60,60)
        btn.Text=name
        btn.TextColor3=Color3.fromRGB(200,200,200)
        btn.TextSize=10
        btn.Font=Enum.Font.Code
        btn.Parent=savedList
        
        btn.MouseButton1Click:Connect(function()
            saveInput.Text=name
        end)
        
        local delBtn=Instance.new("TextButton")
        delBtn.Size=UDim2.new(0,20,0,20)
        delBtn.Position=UDim2.new(1,-20,0,0)
        delBtn.BackgroundColor3=Color3.fromRGB(150,40,40)
        delBtn.BorderSizePixel=0
        delBtn.Text="X"
        delBtn.TextColor3=Color3.fromRGB(255,255,255)
        delBtn.TextSize=10
        delBtn.Font=Enum.Font.Code
        delBtn.Parent=btn
        
        delBtn.MouseButton1Click:Connect(function()
            savedConfigs[name]=nil
            updateSavedList()
            print("Config '"..name.."' deletada!")
        end)
        
        y=y+22
    end
    
    savedList.CanvasSize=UDim2.new(0,0,0,y)
end

saveBtn.MouseButton1Click:Connect(function()
    saveConfig(saveInput.Text)
end)

loadBtn.MouseButton1Click:Connect(function()
    loadConfig(saveInput.Text)
end)

updateTargetVisual=function()
    for name,btn in pairs(targetBtns) do
        if name==config.targetPart then
            btn.BackgroundColor3=Color3.fromRGB(80,80,80)
            btn.TextColor3=Color3.fromRGB(255,255,255)
            btn.BorderColor3=Color3.fromRGB(100,100,100)
            if bodyVisuals[name] then
                bodyVisuals[name].BorderSizePixel=2
                bodyVisuals[name].BorderColor3=Color3.fromRGB(100,255,100)
            end
        else
            btn.BackgroundColor3=Color3.fromRGB(35,35,35)
            btn.TextColor3=Color3.fromRGB(180,180,180)
            btn.BorderColor3=Color3.fromRGB(60,60,60)
            if bodyVisuals[name] then
                bodyVisuals[name].BorderSizePixel=1
                bodyVisuals[name].BorderColor3=Color3.fromRGB(60,60,60)
            end
        end
    end
end

updateAimMode=function()
    if config.aimMode=="F" then
        modeF.BackgroundColor3=Color3.fromRGB(100,100,100)
        modeF.TextColor3=Color3.fromRGB(255,255,255)
        modeF.BorderColor3=Color3.fromRGB(120,120,120)
        modeC.BackgroundColor3=Color3.fromRGB(50,50,50)
        modeC.TextColor3=Color3.fromRGB(150,150,150)
        modeC.BorderColor3=Color3.fromRGB(70,70,70)
    else
        modeC.BackgroundColor3=Color3.fromRGB(100,100,100)
        modeC.TextColor3=Color3.fromRGB(255,255,255)
        modeC.BorderColor3=Color3.fromRGB(120,120,120)
        modeF.BackgroundColor3=Color3.fromRGB(50,50,50)
        modeF.TextColor3=Color3.fromRGB(150,150,150)
        modeF.BorderColor3=Color3.fromRGB(70,70,70)
    end
end

toggleButton=function(toggle,state)
    if state then
        toggle.btn.BackgroundColor3=Color3.fromRGB(60,150,60)
        toggle.btn.Text="ON"
    else
        toggle.btn.BackgroundColor3=Color3.fromRGB(150,60,60)
        toggle.btn.Text="OFF"
    end
end

-- ============================================
-- ESP FUNCTIONS (CORRIGIDAS)
-- ============================================

local playerConnections={}

local function checkIfGameHasTeams()
    if teamCheckComplete then return gameHasTeams end
    
    local playersWithTeams=0
    local totalPlayers=0
    
    for _,p in pairs(plrs:GetPlayers()) do
        totalPlayers=totalPlayers+1
        if p.Team and p.Team~=game:GetService("Teams"):FindFirstChild("Neutral") then
            playersWithTeams=playersWithTeams+1
        end
    end
    
    if totalPlayers>=2 then
        gameHasTeams=(playersWithTeams>=totalPlayers*0.5)
        teamCheckComplete=true
        
        if gameHasTeams then
            print("[EXPLOITS A] Sistema de times detectado!")
        else
            print("[EXPLOITS A] Sem times - Todos com aura branca")
        end
    end
    
    return gameHasTeams
end

local function getColor(p)
    local hasTeams=checkIfGameHasTeams()
    
    if not hasTeams then
        return Color3.fromRGB(255,255,255)
    end
    
    if not p.Team or not lp.Team then return Color3.fromRGB(255,255,0) end
    return p.Team==lp.Team and Color3.fromRGB(0,255,100) or Color3.fromRGB(255,60,60)
end

local function removeHL(p)
    if cache[p] then 
        pcall(function() 
            if cache[p].Parent then 
                cache[p]:Destroy() 
            end 
        end) 
        cache[p]=nil 
    end
end

local function createHL(p,c)
    if p==lp or not c then return end
    
    -- Remove highlight antigo se existir
    removeHL(p)
    
    -- Cria o highlight
    local success,err=pcall(function()
        local hrp=c:WaitForChild("HumanoidRootPart",10)
        if not hrp or not c.Parent then return end
        
        local h=Instance.new("Highlight")
        h.Name="ESP_"..p.Name
        h.Adornee=c
        h.FillColor=getColor(p)
        h.OutlineColor=getColor(p)
        h.FillTransparency=0.65
        h.OutlineTransparency=0
        h.DepthMode=Enum.HighlightDepthMode.AlwaysOnTop
        h.Enabled=config.espOn
        h.Parent=c
        cache[p]=h
    end)
    
    if not success then
        print("[ESP] Erro ao criar highlight para "..p.Name..": "..tostring(err))
    end
end

local function updateHL(p)
    local h=cache[p]
    if h and h.Parent then
        local nc=getColor(p)
        h.FillColor=nc
        h.OutlineColor=nc
    end
end

local function cleanupPlayerConnections(p)
    if playerConnections[p] then
        for _,conn in pairs(playerConnections[p]) do
            pcall(function() conn:Disconnect() end)
        end
        playerConnections[p]=nil
    end
end

local function setupPlayer(p)
    if p==lp then return end
    
    -- Limpa conexões antigas
    cleanupPlayerConnections(p)
    playerConnections[p]={}
    
    -- Função para criar ESP quando character estiver pronto
    local function handleCharacter(c)
        if not c then return end
        
        task.wait(0.5) -- Aguarda character carregar completamente
        
        -- Verifica se character ainda existe
        if not c.Parent then return end
        
        createHL(p,c)
        
        -- Monitora quando humanoid morre
        local hum=c:FindFirstChild("Humanoid")
        if hum then
            table.insert(playerConnections[p], hum.Died:Connect(function()
                print("[ESP] "..p.Name.." morreu - removendo highlight")
                removeHL(p)
            end))
        end
        
        -- Monitora quando character é destruído
        table.insert(playerConnections[p], c.AncestryChanged:Connect(function()
            if not c.Parent then 
                print("[ESP] Character de "..p.Name.." removido")
                removeHL(p)
            end 
        end))
    end
    
    -- Se já tem character, cria ESP
    if p.Character then 
        handleCharacter(p.Character)
    end
    
    -- Quando character é adicionado (respawn)
    table.insert(playerConnections[p], p.CharacterAdded:Connect(function(c) 
        print("[ESP] "..p.Name.." respawnou - criando highlight")
        removeHL(p) -- Remove qualquer highlight antigo
        task.wait(0.3)
        handleCharacter(c)
    end))
    
    -- Quando character é removido
    table.insert(playerConnections[p], p.CharacterRemoving:Connect(function() 
        print("[ESP] Character de "..p.Name.." sendo removido")
        removeHL(p) 
    end))
    
    -- Quando muda de time
    table.insert(playerConnections[p], p:GetPropertyChangedSignal("Team"):Connect(function() 
        print("[ESP] "..p.Name.." mudou de time - atualizando cor")
        updateHL(p)
        -- Re-cria o highlight com a nova cor
        if p.Character and p.Character.Parent then
            task.wait(0.1)
            removeHL(p)
            createHL(p,p.Character)
        end
    end))
end

-- SISTEMA DE QUALIDADE SIMPLIFICADO (SÓ REDUZ QUALIDADE GRÁFICA)
local qualityLevels={
    [1]=Enum.QualityLevel.Level01,
    [2]=Enum.QualityLevel.Level02,
    [3]=Enum.QualityLevel.Level03,
    [4]=Enum.QualityLevel.Level04,
    [5]=Enum.QualityLevel.Level05,
    [6]=Enum.QualityLevel.Level06,
    [7]=Enum.QualityLevel.Level07,
    [8]=Enum.QualityLevel.Level08,
    [9]=Enum.QualityLevel.Level09,
    [10]=Enum.QualityLevel.Level10,
    [11]=Enum.QualityLevel.Level11,
    [12]=Enum.QualityLevel.Level12,
    [13]=Enum.QualityLevel.Level13,
    [14]=Enum.QualityLevel.Level14,
    [15]=Enum.QualityLevel.Level15,
    [16]=Enum.QualityLevel.Level16,
    [17]=Enum.QualityLevel.Level17,
    [18]=Enum.QualityLevel.Level18,
    [19]=Enum.QualityLevel.Level19,
    [20]=Enum.QualityLevel.Level20,
    [21]=Enum.QualityLevel.Level21
}

local originalQuality=nil

local function updateQuality()
    if not config.texCullOn then return end
    
    local level=qualityLevels[config.qualityLevel] or Enum.QualityLevel.Level10
    settings().Rendering.QualityLevel=level
    qualityUpdateNeeded=false
end

local function applyCull()
    if tick()-lastCullUpdate<1 then return end
    lastCullUpdate=tick()
    
    if not config.texCullOn then return end
    
    if qualityUpdateNeeded then
        updateQuality()
    end
    
    if not originalQuality then
        originalQuality=settings().Rendering.QualityLevel
    end
    
    local level=qualityLevels[config.qualityLevel] or Enum.QualityLevel.Level10
    settings().Rendering.QualityLevel=level
end

local function restoreTex()
    if originalQuality then
        settings().Rendering.QualityLevel=originalQuality
        originalQuality=nil
    end
    
    cullCache={}
end

-- AIMBOT OTIMIZADO COM SUPORTE R6 E R15
local function getClosest()
    local closest,shortest=nil,config.fovVal
    local center=Vector2.new(cam.ViewportSize.X/2,cam.ViewportSize.Y/2)
    
    for _,p in pairs(plrs:GetPlayers()) do
        if p~=lp and p.Character then
            local hum=p.Character:FindFirstChild("Humanoid")
            
            if hum and hum.Health>0 then
                local target=nil
                
                if config.targetPart=="Head" then
                    target=p.Character:FindFirstChild("Head")
                elseif config.targetPart=="UpperTorso" or config.targetPart=="Torso" then
                    target=p.Character:FindFirstChild("UpperTorso") or p.Character:FindFirstChild("Torso") or p.Character:FindFirstChild("HumanoidRootPart")
                elseif config.targetPart=="LeftUpperArm" or config.targetPart=="LeftArm" then
                    target=p.Character:FindFirstChild("LeftUpperArm") or p.Character:FindFirstChild("Left Arm")
                elseif config.targetPart=="RightUpperArm" or config.targetPart=="RightArm" then
                    target=p.Character:FindFirstChild("RightUpperArm") or p.Character:FindFirstChild("Right Arm")
                elseif config.targetPart=="LeftUpperLeg" or config.targetPart=="LeftLeg" then
                    target=p.Character:FindFirstChild("LeftUpperLeg") or p.Character:FindFirstChild("Left Leg")
                elseif config.targetPart=="RightUpperLeg" or config.targetPart=="RightLeg" then
                    target=p.Character:FindFirstChild("RightUpperLeg") or p.Character:FindFirstChild("Right Leg")
                end
                
                if target then
                    if not config.aimAtTeammates and lp.Team and p.Team and p.Team==lp.Team then 
                        continue 
                    end
                    
                    if not config.wallCheck then
                        local ray=Ray.new(cam.CFrame.Position,(target.Position-cam.CFrame.Position).Unit*500)
                        local hit=workspace:FindPartOnRayWithIgnoreList(ray,{lp.Character,cam})
                        if hit and not p.Character:IsAncestorOf(hit) then continue end
                    end
                    
                    local sp,onScreen=cam:WorldToViewportPoint(target.Position)
                    if onScreen then
                        local dist=(Vector2.new(sp.X,sp.Y)-center).Magnitude
                        if dist<shortest then
                            shortest=dist
                            closest=p
                        end
                    end
                end
            end
        end
    end
    
    return closest
end

local function aimAt(p)
    if not p or not p.Character then return end
    
    local target=nil
    
    if config.targetPart=="Head" then
        target=p.Character:FindFirstChild("Head")
    elseif config.targetPart=="UpperTorso" or config.targetPart=="Torso" then
        target=p.Character:FindFirstChild("UpperTorso") or p.Character:FindFirstChild("Torso") or p.Character:FindFirstChild("HumanoidRootPart")
    elseif config.targetPart=="LeftUpperArm" or config.targetPart=="LeftArm" then
        target=p.Character:FindFirstChild("LeftUpperArm") or p.Character:FindFirstChild("Left Arm")
    elseif config.targetPart=="RightUpperArm" or config.targetPart=="RightArm" then
        target=p.Character:FindFirstChild("RightUpperArm") or p.Character:FindFirstChild("Right Arm")
    elseif config.targetPart=="LeftUpperLeg" or config.targetPart=="LeftLeg" then
        target=p.Character:FindFirstChild("LeftUpperLeg") or p.Character:FindFirstChild("Left Leg")
    elseif config.targetPart=="RightUpperLeg" or config.targetPart=="RightLeg" then
        target=p.Character:FindFirstChild("RightUpperLeg") or p.Character:FindFirstChild("Right Leg")
    end
    
    if not target then return end
    
    local targetPos=target.Position
    if config.prediction>0 then
        local hrp=p.Character:FindFirstChild("HumanoidRootPart")
        if hrp then
            local vel=hrp.Velocity
            targetPos=targetPos+(vel*config.prediction)
        end
    end
    
    local newCF=CFrame.new(cam.CFrame.Position,targetPos)
    cam.CFrame=cam.CFrame:Lerp(newCF,1-config.smoothness)
end

-- CONECTAR TOGGLES
espToggle.btn.MouseButton1Click:Connect(function()
    config.espOn=not config.espOn
    toggleButton(espToggle,config.espOn)
    for p,h in pairs(cache) do if h and h.Parent then h.Enabled=config.espOn end end
end)

aimToggle.btn.MouseButton1Click:Connect(function()
    config.aimOn=not config.aimOn
    toggleButton(aimToggle,config.aimOn)
    fovCirc.Visible=config.aimOn
end)

cullToggle.btn.MouseButton1Click:Connect(function()
    config.texCullOn=not config.texCullOn
    toggleButton(cullToggle,config.texCullOn)
    if config.texCullOn then
        applyCull()
    else
        restoreTex()
    end
end)

wallToggle.btn.MouseButton1Click:Connect(function()
    config.wallCheck=not config.wallCheck
    toggleButton(wallToggle,config.wallCheck)
end)

teammateToggle.btn.MouseButton1Click:Connect(function()
    config.aimAtTeammates=not config.aimAtTeammates
    toggleButton(teammateToggle,config.aimAtTeammates)
    if config.aimAtTeammates then
        print("[EXPLOITS A] Aimbot agora mira em TODOS (incluindo amigos)")
    else
        print("[EXPLOITS A] Aimbot NÃO mira em amigos do mesmo time")
    end
end)

modeF.MouseButton1Click:Connect(function()
    config.aimMode="F"
    updateAimMode()
end)

modeC.MouseButton1Click:Connect(function()
    config.aimMode="CTRL"
    updateAimMode()
end)

-- SLIDERS
local function handleSlider(slider,callback)
    local dragging=false
    
    slider.button.MouseButton1Down:Connect(function() dragging=true end)
    uis.InputEnded:Connect(function(i) if i.UserInputType==Enum.UserInputType.MouseButton1 then dragging=false end end)
    
    rs.RenderStepped:Connect(function()
        if dragging then
            local mp=uis:GetMouseLocation()
            local pos=slider.button.AbsolutePosition
            local size=slider.button.AbsoluteSize
            local rx=math.clamp(mp.X-pos.X,0,size.X)
            local pc=rx/size.X
            local val=math.floor(slider.min+(pc*(slider.max-slider.min)))
            
            slider.fill.Size=UDim2.new(pc,0,1,0)
            slider.value.Text=val..(slider.suffix or "")
            callback(val,pc)
        end
    end)
end

handleSlider(smoothSlider,function(val) config.smoothness=val/100 end)
handleSlider(predSlider,function(val) config.prediction=val/100 end)
handleSlider(fovSlider,function(val) config.fovVal=val fovCirc.Radius=val end)
handleSlider(qualitySlider,function(val) 
    config.qualityLevel=val 
    qualityUpdateNeeded=true
    if config.texCullOn then
        applyCull()
    end
end)

-- TARGET BUTTONS
for name,btn in pairs(targetBtns) do
    btn.MouseButton1Click:Connect(function()
        config.targetPart=name
        updateTargetVisual()
    end)
end

-- MINIMIZE/CLOSE
local minimized=false
minBtn.MouseButton1Click:Connect(function()
    minimized=not minimized
    if minimized then
        mf.Size=UDim2.new(0,300,0,35)
        content.Visible=false
        footer.Visible=false
    else
        mf.Size=UDim2.new(0,300,0,500)
        content.Visible=true
        footer.Visible=true
    end
end)

closeBtn.MouseButton1Click:Connect(function()
    mf.Visible=false
end)

-- INPUT
uis.InputBegan:Connect(function(i,gp)
    if i.KeyCode==Enum.KeyCode.Insert then
        mf.Visible=not mf.Visible
        return
    end
    if not config.aimOn then return end
    if config.aimMode=="F" and i.KeyCode==Enum.KeyCode.F then
        config.aimActive=true
    elseif config.aimMode=="CTRL" and (i.KeyCode==Enum.KeyCode.LeftControl or i.KeyCode==Enum.KeyCode.RightControl) then
        config.aimActive=true
    end
end)

uis.InputEnded:Connect(function(i,gp)
    if config.aimMode=="F" and i.KeyCode==Enum.KeyCode.F then
        config.aimActive=false
    elseif config.aimMode=="CTRL" and (i.KeyCode==Enum.KeyCode.LeftControl or i.KeyCode==Enum.KeyCode.RightControl) then
        config.aimActive=false
    end
end)

-- MAIN LOOP OTIMIZADO
if renderConnection then renderConnection:Disconnect() end
renderConnection=rs.RenderStepped:Connect(function()
    fovCirc.Position=Vector2.new(cam.ViewportSize.X/2,cam.ViewportSize.Y/2)
    
    if config.aimActive and config.aimOn then
        local tgt=getClosest()
        if tgt then aimAt(tgt) end
    end
end)

-- CULL LOOP
task.spawn(function()
    while task.wait(2) do
        if config.texCullOn then
            task.spawn(applyCull)
        end
    end
end)

-- PLAYER SETUP
for _,p in pairs(plrs:GetPlayers()) do 
    task.spawn(function() 
        setupPlayer(p) 
    end) 
end

plrs.PlayerAdded:Connect(function(p) 
    print("[ESP] Novo jogador entrou: "..p.Name)
    task.spawn(function() 
        setupPlayer(p)
        if not teamCheckComplete then
            task.wait(2)
            checkIfGameHasTeams()
        end
    end) 
end)

plrs.PlayerRemoving:Connect(function(p) 
    print("[ESP] Jogador saiu: "..p.Name)
    removeHL(p)
    cleanupPlayerConnections(p)
end)

lp:GetPropertyChangedSignal("Team"):Connect(function()
    print("[ESP] Seu time mudou - atualizando todos os highlights")
    for p,_ in pairs(cache) do 
        updateHL(p) 
        if p.Character and p.Character.Parent then
            task.wait(0.1)
            removeHL(p)
            createHL(p,p.Character)
        end
    end
    teamCheckComplete=false
    checkIfGameHasTeams()
end)

-- LOOP DE VERIFICAÇÃO DE HIGHLIGHTS PERDIDOS
task.spawn(function()
    while task.wait(3) do
        for _,p in pairs(plrs:GetPlayers()) do
            if p~=lp and p.Character and p.Character.Parent then
                local hum=p.Character:FindFirstChild("Humanoid")
                if hum and hum.Health>0 and not cache[p] then 
                    print("[ESP] Re-criando highlight perdido para: "..p.Name)
                    createHL(p,p.Character) 
                end
            end
        end
    end
end)

-- CHECAGEM INICIAL DE TIMES
task.spawn(function()
    task.wait(3)
    checkIfGameHasTeams()
    for p,_ in pairs(cache) do updateHL(p) end
end)

updateTargetVisual()
updateAimMode()
print("==========================================")
print("Exploits A - Painel BETA carregado!")
print("ESP CORRIGIDO - Detecta:")
print("  - Mortes e respawns")
print("  - Mudancas de time")
print("  - Jogadores saindo/entrando")
print("  - Sistema automatico de times")
print("==========================================")
